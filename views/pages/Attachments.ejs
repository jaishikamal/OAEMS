<!-- View: Attachments Management -->
<!-- Filename: Attachments.ejs -->
<!-- Path: views/pages/Attachments.ejs -->

<!-- Content -->
<div class="container-xxl flex-grow-1 container-p-y">
  <!-- Success/Error Messages -->
  <% if (typeof success !== 'undefined' && success) { %>
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    <%= success %>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  <% } %> <% if (typeof error !== 'undefined' && error) { %>
  <div class="alert alert-danger alert-dismissible fade show" role="alert">
    <%= error %>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  <% } %>

  <!-- Header section-->
  <div class="row gy-3 align-items-center mb-4">
    <div class="col-lg-6">
      <div class="d-flex align-items-start gap-2">
        <div class="avatar avatar-md flex-shrink-0 bg-label-primary">
          <span class="avatar-initial rounded">
            <i class="icon-base ti tabler-paperclip"></i>
          </span>
        </div>
        <div>
          <h4 class="mb-1">Attachments Management</h4>
          <p class="text-muted mb-0">
            Manage your expense governance attachments here.
          </p>
        </div>
      </div>
    </div>
    <div class="col-lg-6 d-flex flex-wrap justify-content-lg-end gap-2">
      <button
        type="button"
        class="btn btn-label-primary"
        data-bs-toggle="modal"
        data-bs-target="#addModal"
      >
        <i class="icon-base ti tabler-upload me-1"></i>Upload Attachment
      </button>
    </div>
  </div>
  <!--Header section---->

  <div class="row">
    <div class="col-12">
      <!-- Attachments Table -->
      <div class="card">
        <div class="card-datatable">
          <table class="datatables-users table border-top">
            <thead>
              <tr>
                <th width="5%">ID</th>
                <th width="25%">Attachment Type</th>
                <th width="15%">Requirement</th>
                <th width="15%">Status</th>
                <th width="20%">File Path</th>
                <th width="10%">Uploaded Date</th>
                <th width="10%" class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              <% if (attachmentTypes && attachmentTypes.length > 0) { %>
                <% attachmentTypes.forEach(function(type) { 
                  const existingAttachment = attachments.find(att => att.attachment_type === type.name);
                  const isUploaded = !!existingAttachment;
                %>
                <tr>
                  <td><%= isUploaded ? existingAttachment.id : '-' %></td>
                  <td>
                    <strong><%= type.name %></strong>
                  </td>
                  <td>
                    <% if (type.mandatory) { %>
                      <span class="badge bg-label-danger">Mandatory</span>
                    <% } else if (type.name === 'VAT Certificate') { %>
                      <span class="badge bg-label-warning">Conditional</span>
                    <% } else { %>
                      <span class="badge bg-label-info">Optional</span>
                    <% } %>
                  </td>
                  <td>
                    <% if (isUploaded) { %>
                      <span class="badge bg-label-success">
                        <i class="icon-base ti tabler-check me-1"></i>Uploaded
                      </span>
                    <% } else { %>
                      <span class="badge bg-label-secondary">
                        <i class="icon-base ti tabler-x me-1"></i>Not Uploaded
                      </span>
                    <% } %>
                  </td>
                  <td>
                    <% if (isUploaded) { %>
                      <div class="text-truncate" style="max-width: 200px;" title="<%= existingAttachment.file_path %>">
                        <i class="icon-base ti tabler-file me-1"></i>
                        <%= existingAttachment.file_path.split('/').pop() %>
                      </div>
                    <% } else { %>
                      <span class="text-muted">-</span>
                    <% } %>
                  </td>
                  <td>
                    <% if (isUploaded && existingAttachment.uploaded_at) { %>
                      <small><%= new Date(existingAttachment.uploaded_at).toLocaleDateString() %></small>
                    <% } else { %>
                      <span class="text-muted">-</span>
                    <% } %>
                  </td>
                  <td class="text-end">
                    <div class="d-inline-flex gap-2">
                      <% if (isUploaded) { %>
                        <a
                          href="/Attachments/<%= existingAttachment.id %>/download"
                          class="btn btn-sm btn-icon btn-text-primary rounded-pill"
                          title="Download"
                        >
                          <i class="icon-base ti tabler-download"></i>
                        </a>
                        <button
                          class="btn btn-sm btn-icon btn-text-secondary rounded-pill btn-edit"
                          data-id="<%= existingAttachment.id %>"
                          data-attachment-type="<%= existingAttachment.attachment_type %>"
                          title="Edit"
                        >
                          <i class="icon-base ti tabler-edit"></i>
                        </button>
                        <form
                          action="/Attachments/<%= existingAttachment.id %>/delete"
                          method="POST"
                          class="d-inline delete-form"
                        >
                          <button
                            class="btn btn-sm btn-icon btn-text-danger rounded-pill"
                            type="submit"
                            title="Delete"
                          >
                            <i class="icon-base ti tabler-trash"></i>
                          </button>
                        </form>
                      <% } else { %>
                        <button
                          class="btn btn-sm btn-icon btn-text-primary rounded-pill btn-upload"
                          data-type="<%= type.name %>"
                          title="Upload"
                        >
                          <i class="icon-base ti tabler-upload"></i>
                        </button>
                      <% } %>
                    </div>
                  </td>
                </tr>
                <% }); %>
              <% } else { %>
                <tr>
                  <td colspan="7" class="text-center py-4">
                    <div class="text-muted">
                      <i class="icon-base ti tabler-alert-circle fs-3 mb-2"></i>
                      <p>No attachment types defined.</p>
                    </div>
                  </td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>

        <!-- Information Card -->
        <div class="card-body">
          <div class="alert alert-info" role="alert">
            <h6 class="alert-heading mb-2">
              <i class="icon-base ti tabler-info-circle me-2"></i>Attachment Guidelines
            </h6>
            <ul class="mb-0">
              <li><strong>PAN Certificate:</strong> Mandatory - Required for all expenses governance</li>
              <li><strong>VAT Certificate:</strong> Conditional - Required based on VAT registration status</li>
              <li><strong>Bank Cheque / Letter:</strong> Mandatory - Bank verification required</li>
              <li><strong>Contract / Agreement:</strong> Optional - Upload if applicable</li>
            </ul>
            <hr>
            <p class="mb-0">
              <strong>Supported formats:</strong> PDF, JPG, PNG, DOC, DOCX (Max size: 5MB)
            </p>
          </div>
        </div>
      </div>
      <!--/ Attachments Table -->
    </div>
  </div>

  <!-- Add Modal -->
  <div class="modal fade" id="addModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body">
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
          <div class="text-center mb-6">
            <h4 class="mb-2">Upload New Attachment</h4>
            <p class="text-body-secondary">Select attachment type and upload file</p>
          </div>

          <!-- Add attachment form -->
          <form action="/Attachments" method="POST" enctype="multipart/form-data">
            <div class="mb-3">
              <label class="form-label" for="attachment_type">
                Attachment Type <span class="text-danger">*</span>
              </label>
              <select
                id="attachment_type"
                name="attachment_type"
                class="form-select"
                required
              >
                <option value="">Select Attachment Type</option>
                <% if (attachmentTypes && attachmentTypes.length > 0) { %>
                  <% attachmentTypes.forEach(function(type) { %>
                    <option value="<%= type.name %>">
                      <%= type.name %> 
                      <% if (type.mandatory) { %>
                        (Mandatory)
                      <% } else if (type.name === 'VAT Certificate') { %>
                        (Conditional)
                      <% } else { %>
                        (Optional)
                      <% } %>
                    </option>
                  <% }); %>
                <% } %>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label" for="attachment_file">
                File <span class="text-danger">*</span>
              </label>
              <input
                type="file"
                id="attachment_file"
                name="attachment_file"
                class="form-control"
                accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                required
              />
              <small class="text-muted">
                Accepted formats: PDF, JPG, PNG, DOC, DOCX (Max: 5MB)
              </small>
            </div>

            <div class="col-12 text-center mt-4">
              <button type="submit" class="btn btn-primary me-3">
                <i class="icon-base ti tabler-upload me-1"></i>Upload Attachment
              </button>
              <button
                type="reset"
                class="btn btn-label-secondary"
                data-bs-dismiss="modal"
                aria-label="Close"
              >
                Cancel
              </button>
            </div>
          </form>
          <!--/ Add attachment form -->
        </div>
      </div>
    </div>
  </div>
  <!--/ Add Modal -->

  <!-- Edit Modal -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body">
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
          <div class="text-center mb-6">
            <h4 class="mb-2">Edit Attachment</h4>
            <p class="text-body-secondary">Update attachment details</p>
          </div>

          <!-- Edit attachment form -->
          <form id="editForm" method="POST" enctype="multipart/form-data">
            <input type="hidden" id="edit_id" name="id" />

            <div class="mb-3">
              <label class="form-label" for="edit_attachment_type">
                Attachment Type <span class="text-danger">*</span>
              </label>
              <select
                id="edit_attachment_type"
                name="attachment_type"
                class="form-select"
                required
              >
                <option value="">Select Attachment Type</option>
                <% if (attachmentTypes && attachmentTypes.length > 0) { %>
                  <% attachmentTypes.forEach(function(type) { %>
                    <option value="<%= type.name %>">
                      <%= type.name %> 
                      <% if (type.mandatory) { %>
                        (Mandatory)
                      <% } else if (type.name === 'VAT Certificate') { %>
                        (Conditional)
                      <% } else { %>
                        (Optional)
                      <% } %>
                    </option>
                  <% }); %>
                <% } %>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label" for="edit_attachment_file">
                Replace File (Optional)
              </label>
              <input
                type="file"
                id="edit_attachment_file"
                name="attachment_file"
                class="form-control"
                accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
              />
              <small class="text-muted">
                Leave empty to keep existing file. Upload new file to replace.
              </small>
            </div>

            <div class="col-12 text-center mt-4">
              <button type="submit" class="btn btn-warning me-3">
                <i class="icon-base ti tabler-device-floppy me-1"></i>Update Attachment
              </button>
              <button
                type="reset"
                class="btn btn-label-secondary"
                data-bs-dismiss="modal"
                aria-label="Close"
              >
                Cancel
              </button>
            </div>
          </form>
          <!--/ Edit attachment form -->
        </div>
      </div>
    </div>
  </div>
  <!--/ Edit Modal -->
</div>
<!-- / Content -->

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const addModal = new bootstrap.Modal(document.getElementById("addModal"));
    const editModal = new bootstrap.Modal(document.getElementById("editModal"));
    const editForm = document.getElementById("editForm");

    // Handle upload button clicks
    const uploadButtons = document.querySelectorAll(".btn-upload");
    const attachmentTypeSelect = document.getElementById("attachment_type");

    uploadButtons.forEach((button) => {
      button.addEventListener("click", function () {
        const type = this.getAttribute("data-type");
        if (type) {
          attachmentTypeSelect.value = type;
        }
        addModal.show();
      });
    });

    // Handle edit button clicks
    const editButtons = document.querySelectorAll(".btn-edit");
    editButtons.forEach((button) => {
      button.addEventListener("click", function () {
        const id = this.getAttribute("data-id");
        const attachmentType = this.getAttribute("data-attachment-type");

        // Set form action
        editForm.action = "/Attachments/" + id;

        // Populate form fields
        document.getElementById("edit_id").value = id;
        document.getElementById("edit_attachment_type").value = attachmentType;

        // Show modal
        editModal.show();
      });
    });

    // Confirm delete
    const deleteForms = document.querySelectorAll(".delete-form");
    deleteForms.forEach((form) => {
      form.addEventListener("submit", function (e) {
        if (!confirm("Are you sure you want to delete this attachment?")) {
          e.preventDefault();
        }
      });
    });

    // File validation
    const fileInputs = document.querySelectorAll('input[type="file"]');
    fileInputs.forEach((fileInput) => {
      fileInput.addEventListener("change", function () {
        const maxSize = 5 * 1024 * 1024; // 5MB
        if (this.files[0] && this.files[0].size > maxSize) {
          alert("File size exceeds 5MB. Please select a smaller file.");
          this.value = "";
        }
      });
    });
  });
</script>
