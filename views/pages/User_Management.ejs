<div class="container-xxl flex-grow-1 container-p-y">
  <!-- Header -->
  <div class="row gy-3 align-items-center mb-4">
    <div class="col-lg-6">
      <div class="d-flex align-items-start gap-2">
        <div class="avatar avatar-md flex-shrink-0 bg-label-primary">
          <span class="avatar-initial rounded"><i class="icon-base ti tabler-users"></i></span>
        </div>
        <div>
          <h4 class="mb-1">User Management</h4>
          <p class="text-muted mb-0">Monitor users, roles, permissions, and security signals</p>
        </div>
      </div>
    </div>
    <div class="col-lg-6 d-flex flex-wrap justify-content-lg-end gap-2">
      <button type="button" class="btn btn-outline-secondary">
        <i class="icon-base ti tabler-cloud-upload me-1"></i>Import
      </button>
      <button type="button" class="btn btn-outline-secondary">
        <i class="icon-base ti tabler-download me-1"></i>Export CSV
      </button>
      <button type="button" class="btn btn-label-primary" id="addUserBtn">
        <i class="icon-base ti tabler-plus me-1"></i>Add User
      </button>
    </div>
  </div>

  <!-- Quick stats -->
  <div class="row g-3 mb-4">
    <div class="col-sm-6 col-xl-3">
      <div class="card h-100">
        <div class="card-body d-flex align-items-start justify-content-between">
          <div>
            <p class="text-muted mb-1">Total users</p>
            <h4 class="mb-1"><%= totalUsers || 0 %></h4>
            <small class="text-success">+12 this week</small>
          </div>
          <div class="avatar avatar-sm bg-label-primary">
            <span class="avatar-initial rounded"><i class="icon-base ti tabler-users"></i></span>
          </div>
        </div>
      </div>
    </div>
    <div class="col-sm-6 col-xl-3">
      <div class="card h-100">
        <div class="card-body d-flex align-items-start justify-content-between">
          <div>
            <p class="text-muted mb-1">Active</p>
            <h4 class="mb-1"><%= activeUsers || 0 %></h4>
            <small class="text-success"><%= totalUsers > 0 ? Math.round((activeUsers/totalUsers)*100) : 0 %>% health</small>
          </div>
          <div class="avatar avatar-sm bg-label-success">
            <span class="avatar-initial rounded"><i class="icon-base ti tabler-activity"></i></span>
          </div>
        </div>
      </div>
    </div>
    <div class="col-sm-6 col-xl-3">
      <div class="card h-100">
        <div class="card-body d-flex align-items-start justify-content-between">
          <div>
            <p class="text-muted mb-1">Pending invites</p>
            <h4 class="mb-1"><%= pendingUsers || 0 %></h4>
            <small class="text-warning">Follow-ups needed</small>
          </div>
          <div class="avatar avatar-sm bg-label-warning">
            <span class="avatar-initial rounded"><i class="icon-base ti tabler-mail"></i></span>
          </div>
        </div>
      </div>
    </div>
    <div class="col-sm-6 col-xl-3">
      <div class="card h-100">
        <div class="card-body d-flex align-items-start justify-content-between">
          <div>
            <p class="text-muted mb-1">Admins</p>
            <h4 class="mb-1"><%= adminUsers || 0 %></h4>
            <small class="text-danger">Review access quarterly</small>
          </div>
          <div class="avatar avatar-sm bg-label-danger">
            <span class="avatar-initial rounded"><i class="icon-base ti tabler-shield"></i></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters + bulk actions -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row gy-3 align-items-center">
        <div class="col-lg-4">
          <label class="form-label mb-1">Quick search</label>
          <div class="input-group input-group-merge">
            <span class="input-group-text"><i class="icon-base ti tabler-search"></i></span>
            <input type="text" class="form-control" id="searchUserInput" placeholder="Search name, email, role" />
          </div>
        </div>
        <div class="col-sm-6 col-lg-2">
          <label class="form-label mb-1">Role</label>
          <select class="form-select" id="roleFilter">
            <option value="">All roles</option>
            <% if (roles && roles.length > 0) { %>
              <% roles.forEach(role => { %>
                <option value="<%= role.name %>"><%= role.name %></option>
              <% }) %>
            <% } %>
          </select>
        </div>
        <div class="col-sm-6 col-lg-2">
          <label class="form-label mb-1">Status</label>
          <select class="form-select" id="statusFilter">
            <option value="">Any status</option>
            <option value="Active">Active</option>
            <option value="Inactive">Inactive</option>
            <option value="Pending">Pending</option>
          </select>
        </div>
        <div class="col-sm-6 col-lg-2">
          <label class="form-label mb-1">Department</label>
          <select class="form-select" id="departmentFilter">
            <option value="">All</option>
            <% if (departments && departments.length > 0) { %>
              <% departments.forEach(dept => { %>
                <option value="<%= dept.name %>"><%= dept.name %></option>
              <% }) %>
            <% } else { %>
              <option value="IT">IT</option>
              <option value="Finance">Finance</option>
              <option value="Operations">Operations</option>
              <option value="Marketing">Marketing</option>
              <option value="HR">HR</option>
            <% } %>
          </select>
        </div>
        <div class="col-sm-6 col-lg-2 d-flex align-items-end justify-content-lg-end gap-2">
          <button type="button" class="btn btn-outline-secondary" id="resetFiltersBtn">
            <i class="icon-base ti tabler-rotate-clockwise"></i>
          </button>
        </div>
      </div>
      <hr class="my-4" />
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
        <div class="d-flex flex-wrap align-items-center gap-2">
          <button type="button" class="btn btn-primary" id="assignRoleBtn" disabled>
            <i class="icon-base ti tabler-user-check me-1"></i>Assign role
          </button>
          <span class="badge bg-label-secondary" id="selectedCount">0 selected</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Users -->
  <div class="card">
    <div class="card-header d-flex flex-wrap align-items-center justify-content-between gap-2">
      <div>
        <p class="text-muted mb-1">People directory</p>
        <h5 class="mb-0">Users table</h5>
      </div>
      <div class="badge bg-label-info">
        <i class="icon-base ti tabler-info-circle me-1"></i>Live data from API
      </div>
    </div>
    <div class="table-responsive text-nowrap">
      <table class="table align-middle mb-0" id="usersTable">
        <thead class="table-light">
          <tr>
            <th width="48"><input type="checkbox" class="form-check-input" id="selectAll" /></th>
            <th>ID</th>
            <th>Full Name</th>
            <th>Email</th>
            <th>Role</th>
            <th>Department</th>
            <th>Branch</th>
            <th>Status</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody class="table-border-bottom-0">
          <% if (users && users.length > 0) { %>
            <% users.forEach((u, index) => { %>
              <tr data-user-id="<%= u.id %>" 
                  data-branch-id="<%= u.branch_id || '' %>" 
                  data-department-id="<%= u.department_id || '' %>"
                  data-department-name="<%= u.department_name || '' %>">
                <td><input type="checkbox" class="form-check-input user-checkbox" value="<%= u.id %>" /></td>
                <td><span class="fw-medium"><%= index + 1 %></span></td>
                <td>
                  <div class="d-flex align-items-center">
                    <div class="avatar avatar-sm me-2">
                      <span class="avatar-initial rounded-circle bg-label-primary">
                        <%= u.name ? u.name.split(" ").map(n => n[0]).join("") : "U" %>
                      </span>
                    </div>
                    <div>
                      <span class="fw-medium" data-field="name"><%= u.name %></span>
                    </div>
                  </div>
                </td>
                <td data-field="email"><%= u.email %></td>
                <td data-field="role">
                  <% if (u.roles && u.roles.length) { %>
                    <span class="badge bg-label-primary"><%= u.roles[0].name %></span>
                  <% } else { %>
                    <span class="badge bg-label-secondary">No role</span>
                  <% } %>
                </td>
                <td data-field="department">
                  <% if (u.department_name && u.department_name.trim() !== '') { %>
                    <%= u.department_name %>
                  <% } else { %>
                    <span class="text-muted">Not set</span>
                  <% } %>
                </td>
                <td data-field="branch">
                  <% if (u.branch_name) { %>
                    <%= u.branch_name %>
                  <% } else if (u.branch && u.branch.name) { %>
                    <%= u.branch.name %>
                  <% } else if (u.branch_id) { %>
                    Branch #<%= u.branch_id %>
                  <% } else { %>
                    <span class="text-muted">Not assigned</span>
                  <% } %>
                </td>
                <td data-field="status">
                  <% if (u.is_active) { %>
                    <span class="badge bg-label-success">Active</span>
                  <% } else { %>
                    <span class="badge bg-label-danger">Inactive</span>
                  <% } %>
                </td>
                <td class="text-end">
                  <div class="dropdown">
                    <button type="button" class="btn p-0 dropdown-toggle hide-arrow" data-bs-toggle="dropdown">
                      <i class="icon-base ti tabler-dots-vertical"></i>
                    </button>
                    <div class="dropdown-menu">
                      <a class="dropdown-item edit-user-btn" href="#" data-user-id="<%= u.id %>">
                        <i class="icon-base ti tabler-edit me-1"></i>Edit
                      </a>
                      <a class="dropdown-item delete-user-btn text-danger" href="#" data-user-id="<%= u.id %>">
                        <i class="icon-base ti tabler-trash me-1"></i>Delete
                      </a>
                    </div>
                  </div>
                </td>
              </tr>
            <% }) %>
          <% } else { %>
            <tr>
              <td colspan="9" class="text-center text-muted py-4">No users found</td>
            </tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- User modal -->
  <div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <form class="modal-content" id="userForm">
        <div class="modal-header">
          <h5 class="modal-title"><i class="icon-base ti tabler-user-plus me-2"></i>User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Full Name <span class="text-danger">*</span></label>
              <input type="text" class="form-control" name="fullName" id="userFullName" required />
            </div>
            <div class="col-md-6">
              <label class="form-label">Email <span class="text-danger">*</span></label>
              <input type="email" class="form-control" name="email" id="userEmail" required />
            </div>
            <div class="col-md-6">
              <label class="form-label">Role</label>
              <select class="form-select" name="role" id="userRole">
                <option value="">Select Role</option>
                <% if (roles && roles.length > 0) { %>
                  <% roles.forEach(role => { %>
                    <option value="<%= role.name %>"><%= role.name %></option>
                  <% }) %>
                <% } %>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Branch <span class="text-danger">*</span></label>
              <select class="form-select" name="branch" id="userBranch" required>
                <option value="">Select Branch</option>
                <% if (branches && branches.length > 0) { %>
                  <% branches.forEach(branch => { %>
                    <option value="<%= branch.id %>"><%= branch.name %></option>
                  <% }) %>
                <% } %>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Department <span class="text-danger">*</span></label>
              <select class="form-select" name="department" id="userDepartment" required>
                <option value="">Select Department</option>
                <% if (departments && departments.length > 0) { %>
                  <% departments.forEach(dept => { %>
                    <option value="<%= dept.id %>"><%= dept.name %></option>
                  <% }) %>
                <% } else { %>
                  <option value="1">IT</option>
                  <option value="2">Finance</option>
                  <option value="3">Operations</option>
                  <option value="4">Marketing</option>
                  <option value="5">HR</option>
                <% } %>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Status</label>
              <select class="form-select" name="status" id="userStatus">
                <option value="Active">Active</option>
                <option value="Inactive">Inactive</option>
                <option value="Pending">Pending</option>
              </select>
            </div>
            <div class="col-12">
              <label class="form-label">Notes</label>
              <textarea class="form-control" name="notes" id="userNotes" rows="2" placeholder="Access scope, onboarding steps, etc."></textarea>
            </div>
            <div class="col-12">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" name="twoFactor" id="twoFactorToggle" />
                <label class="form-check-label" for="twoFactorToggle">Require 2FA</label>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="feedbackToast" class="toast align-items-center text-bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">Action completed successfully</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>
</div>

<script>
// User Management JavaScript
(function() {
  'use strict';
  
  // Wait for DOM to be ready
  document.addEventListener('DOMContentLoaded', function() {
    console.log('User Management initialized');
    
    // Initialize Bootstrap components
    const userModalEl = document.getElementById('userModal');
    const feedbackToastEl = document.getElementById('feedbackToast');
    
    if (!userModalEl || !feedbackToastEl) {
      console.error('Required modal or toast elements not found');
      return;
    }
    
    const userModal = new bootstrap.Modal(userModalEl);
    const feedbackToast = new bootstrap.Toast(feedbackToastEl);
    
    // State management
    let selectedUsers = new Set();
    let currentEditingUserId = null;

    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    function showToast(message, type = 'success') {
      const toastEl = document.getElementById('feedbackToast');
      const toastBody = toastEl.querySelector('.toast-body');
      toastBody.textContent = message;
      toastEl.className = `toast align-items-center border-0 ${
        type === 'error' ? 'text-bg-danger' : 'text-bg-primary'
      }`;
      feedbackToast.show();
    }

    function updateSelectedCount() {
      const count = selectedUsers.size;
      const selectedCountEl = document.getElementById('selectedCount');
      const assignRoleBtn = document.getElementById('assignRoleBtn');
      
      if (selectedCountEl) {
        selectedCountEl.textContent = `${count} selected`;
      }
      if (assignRoleBtn) {
        assignRoleBtn.disabled = count === 0;
      }
    }

    // ============================================
    // SEARCH & FILTER
    // ============================================
    function filterTable() {
      const searchTerm = document.getElementById('searchUserInput')?.value.toLowerCase() || '';
      const roleValue = document.getElementById('roleFilter')?.value || '';
      const statusValue = document.getElementById('statusFilter')?.value || '';
      const departmentValue = document.getElementById('departmentFilter')?.value || '';

      const rows = document.querySelectorAll('#usersTable tbody tr');
      
      rows.forEach(row => {
        if (row.cells.length <= 1) return;
        
        const name = row.cells[2].textContent.toLowerCase();
        const email = row.cells[3].textContent.toLowerCase();
        const role = row.cells[4].textContent.trim();
        const department = row.cells[5].textContent.trim();
        const status = row.cells[7].textContent.trim();

        const matchesSearch = name.includes(searchTerm) || email.includes(searchTerm);
        const matchesRole = !roleValue || role.includes(roleValue);
        const matchesStatus = !statusValue || status === statusValue;
        const matchesDepartment = !departmentValue || department.includes(departmentValue);

        row.style.display = (matchesSearch && matchesRole && matchesStatus && matchesDepartment) ? '' : 'none';
      });
    }

    // Attach filter listeners
    const searchInput = document.getElementById('searchUserInput');
    const roleFilter = document.getElementById('roleFilter');
    const statusFilter = document.getElementById('statusFilter');
    const departmentFilter = document.getElementById('departmentFilter');
    const resetFiltersBtn = document.getElementById('resetFiltersBtn');

    searchInput?.addEventListener('input', filterTable);
    roleFilter?.addEventListener('change', filterTable);
    statusFilter?.addEventListener('change', filterTable);
    departmentFilter?.addEventListener('change', filterTable);

    resetFiltersBtn?.addEventListener('click', function() {
      if (searchInput) searchInput.value = '';
      if (roleFilter) roleFilter.value = '';
      if (statusFilter) statusFilter.value = '';
      if (departmentFilter) departmentFilter.value = '';
      filterTable();
    });

    // ============================================
    // CHECKBOX SELECTION
    // ============================================
    const selectAllCheckbox = document.getElementById('selectAll');
    
    selectAllCheckbox?.addEventListener('change', function() {
      const checkboxes = document.querySelectorAll('.user-checkbox');
      checkboxes.forEach(cb => {
        cb.checked = this.checked;
        if (this.checked) {
          selectedUsers.add(cb.value);
        } else {
          selectedUsers.delete(cb.value);
        }
      });
      updateSelectedCount();
    });

    // Individual checkbox change
    document.addEventListener('change', function(e) {
      if (e.target.classList.contains('user-checkbox')) {
        if (e.target.checked) {
          selectedUsers.add(e.target.value);
        } else {
          selectedUsers.delete(e.target.value);
        }
        updateSelectedCount();
        
        // Update "select all" checkbox
        const allCheckboxes = document.querySelectorAll('.user-checkbox');
        const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
        if (selectAllCheckbox) {
          selectAllCheckbox.checked = allChecked;
        }
      }
    });

    // ============================================
    // ADD USER
    // ============================================
    const addUserBtn = document.getElementById('addUserBtn');
    const userForm = document.getElementById('userForm');

    addUserBtn?.addEventListener('click', function() {
      currentEditingUserId = null;
      userForm.reset();
      document.querySelector('#userModal .modal-title').innerHTML = 
        '<i class="icon-base ti tabler-user-plus me-2"></i>Add New User';
      userModal.show();
    });

    // ============================================
    // EDIT USER
    // ============================================
    document.addEventListener('click', function(e) {
      const editBtn = e.target.closest('.edit-user-btn');
      if (editBtn) {
        e.preventDefault();
        const userId = editBtn.dataset.userId;
        const row = document.querySelector(`tr[data-user-id="${userId}"]`);
        
        if (row) {
          currentEditingUserId = userId;
          
          // Get data from data attributes and cells
          const name = row.querySelector('[data-field="name"]')?.textContent.trim() || '';
          const email = row.querySelector('[data-field="email"]')?.textContent.trim() || '';
          const roleBadge = row.querySelector('[data-field="role"] .badge')?.textContent.trim() || '';
          const departmentId = row.dataset.departmentId || '';
          const statusBadge = row.querySelector('[data-field="status"] .badge')?.textContent.trim() || '';
          const branchId = row.dataset.branchId || '';
          
          // Populate form fields
          document.getElementById('userFullName').value = name;
          document.getElementById('userEmail').value = email;
          document.getElementById('userRole').value = roleBadge === 'No role' ? '' : roleBadge;
          document.getElementById('userStatus').value = statusBadge;
          document.getElementById('userBranch').value = branchId;
          document.getElementById('userDepartment').value = departmentId;
          
          document.querySelector('#userModal .modal-title').innerHTML = 
            '<i class="icon-base ti tabler-user-edit me-2"></i>Edit User';
          userModal.show();
        }
      }
    });

    // ============================================
    // DELETE USER
    // ============================================
    document.addEventListener('click', function(e) {
      const deleteBtn = e.target.closest('.delete-user-btn');
      if (deleteBtn) {
        e.preventDefault();
        const userId = deleteBtn.dataset.userId;
        const row = document.querySelector(`tr[data-user-id="${userId}"]`);
        const userName = row?.querySelector('[data-field="name"]')?.textContent.trim() || 'this user';
        
        if (confirm(`Are you sure you want to delete ${userName}?`)) {
          fetch(`/api/users/${userId}`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json'
            }
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              showToast('User deleted successfully!');
              row?.remove();
            } else {
              showToast(data.message || 'Error deleting user', 'error');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            showToast('Error connecting to server', 'error');
          });
        }
      }
    });

    // ============================================
    // SUBMIT USER FORM
    // ============================================
    userForm?.addEventListener('submit', function(e) {
      e.preventDefault();
      
      // Get form values
      const branchId = document.getElementById('userBranch').value;
      const departmentId = document.getElementById('userDepartment').value;
      
      // Validate branch selection
      if (!branchId) {
        showToast('Please select a branch', 'error');
        return;
      }
      
      // Validate department
      if (!departmentId) {
        showToast('Please select a department', 'error');
        return;
      }
      
      const formData = {
        name: document.getElementById('userFullName').value.trim(),
        email: document.getElementById('userEmail').value.trim(),
        role: document.getElementById('userRole').value,
        branch_id: branchId,
        department_id: departmentId,
        status: document.getElementById('userStatus').value,
        notes: document.getElementById('userNotes').value.trim(),
        two_factor: document.getElementById('twoFactorToggle').checked
      };

      console.log('Submitting form data:', formData);

      const url = currentEditingUserId ? `/api/users/${currentEditingUserId}` : '/api/users';
      const method = currentEditingUserId ? 'PUT' : 'POST';
      
      fetch(url, {
        method: method,
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
      })
      .then(response => response.json())
      .then(data => {
        console.log('Server response:', data);
        if (data.success) {
          showToast(`User ${currentEditingUserId ? 'updated' : 'created'} successfully!`);
          userModal.hide();
          setTimeout(() => location.reload(), 1000);
        } else {
          showToast(data.message || 'Error saving user', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showToast('Error connecting to server', 'error');
      });
    });

    // ============================================
    // BULK ASSIGN ROLE
    // ============================================
    const assignRoleBtn = document.getElementById('assignRoleBtn');
    assignRoleBtn?.addEventListener('click', function() {
      if (selectedUsers.size === 0) return;
      
      const role = prompt('Enter role to assign:');
      if (role) {
        const userIds = Array.from(selectedUsers);
        
        fetch('/api/users/bulk/assign-role', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ userIds, role })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showToast(`Role assigned to ${selectedUsers.size} user(s)`);
            selectedUsers.clear();
            updateSelectedCount();
            setTimeout(() => location.reload(), 1500);
          } else {
            showToast(data.message || 'Error assigning roles', 'error');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showToast('Error connecting to server', 'error');
        });
      }
    });

    console.log('All event listeners attached successfully');
  });
})();
</script>