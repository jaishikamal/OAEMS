
<%
  pageScripts.push('/js/Usermanagement.js');
%>
<div class="container-xxl flex-grow-1 container-p-y">
  <!-- Header -->
  <div class="row gy-3 align-items-center mb-4">
    <div class="col-lg-6">
      <div class="d-flex align-items-start gap-2">
        <div class="avatar avatar-md flex-shrink-0 bg-label-primary">
          <span class="avatar-initial rounded"
            ><i class="icon-base ti tabler-users"></i
          ></span>
        </div>
        <div>
          <h4 class="mb-1">User Management</h4>
          <p class="text-muted mb-0">
            Monitor users, roles, permissions, and security signals
          </p>
        </div>
      </div>
    </div>
    <div class="col-lg-6 d-flex flex-wrap justify-content-lg-end gap-2">
      <button type="button" class="btn btn-outline-secondary">
        <i class="icon-base ti tabler-cloud-upload me-1"></i>Import
      </button>
      <button type="button" class="btn btn-outline-secondary">
        <i class="icon-base ti tabler-download me-1"></i>Export CSV
      </button>
      <button type="button" class="btn btn-label-primary" id="addUserBtn">
        <i class="icon-base ti tabler-plus me-1"></i>Add User
      </button>
    </div>
  </div>

  <!-- Quick stats -->
  <div class="row g-3 mb-4">
    <div class="col-sm-6 col-xl-3">
      <div class="card h-100">
        <div class="card-body d-flex align-items-start justify-content-between">
          <div>
            <p class="text-muted mb-1">Total users</p>
            <h4 class="mb-1"><%= totalUsers || 0 %></h4>
            <small class="text-success">+12 this week</small>
          </div>
          <div class="avatar avatar-sm bg-label-primary">
            <span class="avatar-initial rounded"
              ><i class="icon-base ti tabler-users"></i
            ></span>
          </div>
        </div>
      </div>
    </div>
    <div class="col-sm-6 col-xl-3">
      <div class="card h-100">
        <div class="card-body d-flex align-items-start justify-content-between">
          <div>
            <p class="text-muted mb-1">Active</p>
            <h4 class="mb-1"><%= activeUsers || 0 %></h4>
            <small class="text-success"
              ><%= totalUsers > 0 ? Math.round((activeUsers/totalUsers)*100) : 0
              %>% health</small
            >
          </div>
          <div class="avatar avatar-sm bg-label-success">
            <span class="avatar-initial rounded"
              ><i class="icon-base ti tabler-activity"></i
            ></span>
          </div>
        </div>
      </div>
    </div>
    <div class="col-sm-6 col-xl-3">
      <div class="card h-100">
        <div class="card-body d-flex align-items-start justify-content-between">
          <div>
            <p class="text-muted mb-1">Pending invites</p>
            <h4 class="mb-1"><%= pendingUsers || 0 %></h4>
            <small class="text-warning">Follow-ups needed</small>
          </div>
          <div class="avatar avatar-sm bg-label-warning">
            <span class="avatar-initial rounded"
              ><i class="icon-base ti tabler-mail"></i
            ></span>
          </div>
        </div>
      </div>
    </div>
    <div class="col-sm-6 col-xl-3">
      <div class="card h-100">
        <div class="card-body d-flex align-items-start justify-content-between">
          <div>
            <p class="text-muted mb-1">Admins</p>
            <h4 class="mb-1"><%= adminUsers || 0 %></h4>
            <small class="text-danger">Review access quarterly</small>
          </div>
          <div class="avatar avatar-sm bg-label-danger">
            <span class="avatar-initial rounded"
              ><i class="icon-base ti tabler-shield"></i
            ></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters + bulk actions -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row gy-3 align-items-center">
        <div class="col-lg-4">
          <label class="form-label mb-1">Quick search</label>
          <div class="input-group input-group-merge">
            <span class="input-group-text"
              ><i class="icon-base ti tabler-search"></i
            ></span>
            <input
              type="text"
              class="form-control"
              id="searchUserInput"
              placeholder="Search name, email, role"
            />
          </div>
        </div>
        <div class="col-sm-6 col-lg-2">
          <label class="form-label mb-1">Role</label>
          <select class="form-select" id="roleFilter">
            <option value="">All roles</option>
            <% if (roles && roles.length > 0) { %> <% roles.forEach(role => { %>
            <option value="<%= role.name %>"><%= role.name %></option>
            <% }) %> <% } %>
          </select>
        </div>
        <div class="col-sm-6 col-lg-2">
          <label class="form-label mb-1">Status</label>
          <select class="form-select" id="statusFilter">
            <option value="">Any status</option>
            <option value="Active">Active</option>
            <option value="Inactive">Inactive</option>
            <option value="Pending">Pending</option>
          </select>
        </div>
        <div class="col-sm-6 col-lg-2">
          <label class="form-label mb-1">Department</label>
          <select class="form-select" id="departmentFilter">
            <option value="">All</option>
            <% if (departments && departments.length > 0) { %> <%
            departments.forEach(dept => { %>
            <option value="<%= dept.id %>"><%= dept.title %></option>
            <% }) %> <% } else { %>
            <option value="IT">IT</option>
            <option value="Finance">Finance</option>
            <option value="Operations">Operations</option>
            <% } %>
          </select>
        </div>
        <div
          class="col-sm-6 col-lg-2 d-flex align-items-end justify-content-lg-end gap-2"
        >
          <button
            type="button"
            class="btn btn-outline-secondary"
            id="resetFiltersBtn"
          >
            <i class="icon-base ti tabler-rotate-clockwise"></i>
          </button>
        </div>
      </div>
      <hr class="my-4" />
      <div
        class="d-flex flex-wrap align-items-center justify-content-between gap-2"
      >
        <div class="d-flex flex-wrap align-items-center gap-2">
          <button
            type="button"
            class="btn btn-primary"
            id="assignRoleBtn"
            disabled
          >
            <i class="icon-base ti tabler-user-check me-1"></i>Assign role
          </button>
          <span class="badge bg-label-secondary" id="selectedCount"
            >0 selected</span
          >
        </div>
      </div>
    </div>
  </div>

  <!-- Users table -->
  <div class="card">
    <div
      class="card-header d-flex flex-wrap align-items-center justify-content-between gap-2"
    >
      <div>
        <p class="text-muted mb-1">People directory</p>
        <h5 class="mb-0">Users table</h5>
      </div>
      <div class="badge bg-label-info">
        <i class="icon-base ti tabler-info-circle me-1"></i>Live data from API
      </div>
    </div>
    <div class="table-responsive text-nowrap">
      <table class="table align-middle mb-0" id="usersTable">
        <thead class="table-light">
          <tr>
            <th width="48">
              <input type="checkbox" class="form-check-input" id="selectAll" />
            </th>
            <th>ID</th>
            <th>Full Name</th>
            <th>Email</th>
            <th>Role</th>
            <th>Department</th>
            <th>Branch</th>
            <th>Status</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody class="table-border-bottom-0">
          <% if (users && users.length > 0) { %> <% users.forEach((u, index) =>
          { %>
          <tr
            data-user-id="<%= u.id %>"
            data-branch-id="<%= u.branch_id || '' %>"
            data-department-id="<%= u.department_id || '' %>"
            data-department-name="<%= u.department_name || '' %>"
          >
            <td>
              <input
                type="checkbox"
                class="form-check-input user-checkbox"
                value="<%= u.id %>"
              />
            </td>
            <td><span class="fw-medium"><%= index + 1 %></span></td>
            <td>
              <div class="d-flex align-items-center">
                <div class="avatar avatar-sm me-2">
                  <span class="avatar-initial rounded-circle bg-label-primary">
                    <%= u.name ? u.name.split(" ").map(n => n[0]).join("") : "U"
                    %>
                  </span>
                </div>
                <div>
                  <span class="fw-medium" data-field="name"><%= u.name %></span>
                </div>
              </div>
            </td>
            <td data-field="email"><%= u.email %></td>
            <td data-field="role">
              <% if (u.roles && u.roles.length) { %>
              <span class="badge bg-label-primary"><%= u.roles[0].name %></span>
              <% } else { %>
              <span class="badge bg-label-secondary">No role</span>
              <% } %>
            </td>
            <td data-field="department">
              <% if (u.department_name && u.department_name.trim() !== '') { %>
              <%= u.department_name %> <% } else { %>
              <span class="text-muted">Not set</span>
              <% } %>
            </td>
            <td data-field="branch">
              <% if (u.branch_name) { %> <%= u.branch_name %> <% } else if
              (u.branch && u.branch.name) { %> <%= u.branch.name %> <% } else if
              (u.branch_id) { %> Branch #<%= u.branch_id %> <% } else { %>
              <span class="text-muted">Not assigned</span>
              <% } %>
            </td>
            <td data-field="status">
              <% if (u.is_active) { %>
              <span class="badge bg-label-success">Active</span>
              <% } else { %>
              <span class="badge bg-label-danger">Inactive</span>
              <% } %>
            </td>
            <td class="text-end">
              <div class="dropdown">
                <button
                  type="button"
                  class="btn p-0 dropdown-toggle hide-arrow"
                  data-bs-toggle="dropdown"
                >
                  <i class="icon-base ti tabler-dots-vertical"></i>
                </button>
                <div class="dropdown-menu">
                  <a
                    class="dropdown-item edit-user-btn"
                    href="#"
                    data-user-id="<%= u.id %>"
                  >
                    <i class="icon-base ti tabler-edit me-1"></i>Edit
                  </a>
                  <a
                    class="dropdown-item delete-user-btn text-danger"
                    href="#"
                    data-user-id="<%= u.id %>"
                  >
                    <i class="icon-base ti tabler-trash me-1"></i>Delete
                  </a>
                </div>
              </div>
            </td>
          </tr>
          <% }) %> <% } else { %>
          <tr>
            <td colspan="9" class="text-center text-muted py-4">
              No users found
            </td>
          </tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Add User Modal -->
  <!-- Fixed User Modal with Password Field -->
  <div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <form class="modal-content" id="userForm">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="icon-base ti tabler-user-plus me-2"></i>User
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label"
                >Full Name <span class="text-danger">*</span></label
              >
              <input
                type="text"
                class="form-control"
                name="fullName"
                id="userFullName"
                required
              />
            </div>
            <div class="col-md-6">
              <label class="form-label"
                >Email <span class="text-danger">*</span></label
              >
              <input
                type="email"
                class="form-control"
                name="email"
                id="userEmail"
                required
              />
            </div>

            <!-- Password field (required for new users, optional for edit) -->
            <div class="col-md-6" id="passwordFieldWrapper">
              <label class="form-label"
                >Password
                <span class="text-danger" id="passwordRequired">*</span></label
              >
              <input
                type="password"
                class="form-control"
                name="password"
                id="userPassword"
                placeholder="Enter password"
              />
              >
            </div>

            <!-- Role - Send role ID not name -->
            <div class="col-md-6">
              <label class="form-label">Role</label>
              <select class="form-select" name="role" id="userRole">
                <option value="">Select Role</option>
                <% if (roles && roles.length > 0) { %> <% roles.forEach(role =>
                { %>
                <option value="<%= role.id %>"><%= role.name %></option>
                <% }) %> <% } %>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label"
                >Branch <span class="text-danger">*</span></label
              >
              <select
                class="form-select"
                name="branch"
                id="userBranch"
                required
              >
                <option value="">Select Branch</option>
                <% if (branches && branches.length > 0) { %> <%
                branches.forEach(branch => { %>
                <option value="<%= branch.id %>"><%= branch.name %></option>
                <% }) %> <% } %>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label"
                >Department <span class="text-danger">*</span></label
              >
              <select
                class="form-select"
                name="department"
                id="userDepartment"
                required
              >
                <option value="">Select Department</option>
                <% if (departments && departments.length > 0) { %> <%
                departments.forEach(dept => { %>
                <option value="<%= dept.id %>"><%= dept.title %></option>
                <% }) %> <% } %>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label">Status</label>
              <select class="form-select" name="status" id="userStatus">
                <option value="Active">Active</option>
                <option value="Inactive">Inactive</option>
              </select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-outline-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <button type="submit" class="btn btn-primary" id="submitUserBtn">
            Save
          </button>
        </div>
      </form>
    </div>
  </div>
  <!--  Action Feedback Toast -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div
      id="feedbackToast"
      class="toast align-items-center text-bg-primary border-0"
      role="alert"
      aria-live="assertive"
      aria-atomic="true"
    >
      <div class="d-flex">
        <div class="toast-body">Action completed successfully</div>
        <button
          type="button"
          class="btn-close btn-close-white me-2 m-auto"
          data-bs-dismiss="toast"
          aria-label="Close"
        ></button>
      </div>
    </div>
  </div>
</div>





