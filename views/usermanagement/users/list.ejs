<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-people"></i> User Management</h5>
        <a href="/usermanagement/users/create" class="btn btn-sm btn-primary">
            <i class="bi bi-plus-circle"></i> Create User
        </a>
    </div>
    <div class="card-body">
        <!-- Filters -->
        <div class="row mb-3">
            <div class="col-md-4">
                <input type="text" class="form-control form-control-sm" placeholder="Search by name or email" 
                       id="searchInput" onkeyup="filterTable()">
            </div>
            <div class="col-md-3">
                <select class="form-control form-control-sm" id="statusFilter" onchange="filterTable()">
                    <option value="">All Status</option>
                    <option value="active">Active</option>
                    <option value="suspended">Suspended</option>
                    <option value="inactive">Inactive</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-control form-control-sm" id="roleFilter" onchange="filterTable()">
                    <option value="">All Roles</option>
                    <option value="ADMIN">Admin</option>
                    <option value="BRANCH_MANAGER">Branch Manager</option>
                    <option value="AUDITOR">Auditor</option>
                </select>
            </div>
        </div>

        <!-- Table -->
        <div class="table-responsive">
            <table class="table table-hover" id="usersTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Username</th>
                        <th>Status</th>
                        <th>Roles</th>
                        <th>Branches</th>
                        <th>Last Login</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (users && users.length > 0) { %>
                        <% users.forEach(user => { %>
                            <tr>
                                <td>
                                    <strong><%- user.firstName %> <%- user.lastName %></strong>
                                </td>
                                <td><%- user.email %></td>
                                <td><%- user.username %></td>
                                <td>
                                    <% if (user.status === 'active') { %>
                                        <span class="badge bg-success">Active</span>
                                    <% } else if (user.status === 'suspended') { %>
                                        <span class="badge bg-warning">Suspended</span>
                                    <% } else { %>
                                        <span class="badge bg-secondary"><%- user.status %></span>
                                    <% } %>
                                    <% if (user.isLocked) { %>
                                        <span class="badge bg-danger">Locked</span>
                                    <% } %>
                                </td>
                                <td>
                                    <% if (user.roles && user.roles.length > 0) { %>
                                        <% user.roles.forEach(role => { %>
                                            <span class="badge bg-info"><%- role.code %></span>
                                        <% }); %>
                                    <% } else { %>
                                        <span class="text-muted">-</span>
                                    <% } %>
                                </td>
                                <td>
                                    <% if (user.branches && user.branches.length > 0) { %>
                                        <small><%- user.branches.length %> branch(es)</small>
                                    <% } else { %>
                                        <span class="text-muted">-</span>
                                    <% } %>
                                </td>
                                <td>
                                    <small class="text-muted">
                                        <%- user.lastLogin ? new Date(user.lastLogin).toLocaleDateString() : '-' %>
                                    </small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="/usermanagement/users/<%- user.id %>/view" class="btn btn-outline-primary" title="View">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <a href="/usermanagement/users/<%- user.id %>/edit" class="btn btn-outline-primary" title="Edit">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <button class="btn btn-outline-danger" onclick="confirmDelete('<%- user.id %>')" title="Delete">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        <% }); %>
                    <% } else { %>
                        <tr>
                            <td colspan="8" class="text-center text-muted py-4">
                                No users found
                            </td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <% if (totalPages && totalPages > 1) { %>
            <nav aria-label="Page navigation" class="mt-3">
                <ul class="pagination justify-content-center">
                    <% for (let i = 1; i <= totalPages; i++) { %>
                        <li class="page-item <% if (i === currentPage) { %>active<% } %>">
                            <a class="page-link" href="/usermanagement/users?page=<%- i %>"><%- i %></a>
                        </li>
                    <% } %>
                </ul>
            </nav>
        <% } %>
    </div>
</div>

<script>
function filterTable() {
    const searchInput = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const roleFilter = document.getElementById('roleFilter').value;
    
    const table = document.getElementById('usersTable');
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    
    for (let i = 0; i < rows.length; i++) {
        let showRow = true;
        const row = rows[i];
        
        if (searchInput) {
            const text = row.textContent.toLowerCase();
            showRow = text.includes(searchInput);
        }
        
        row.style.display = showRow ? '' : 'none';
    }
}

function confirmDelete(userId) {
    if (confirm('Are you sure you want to delete this user?')) {
        fetch(`/usermanagement/users/${userId}`, {method: 'DELETE'})
            .then(response => {
                if (response.ok) {
                    location.reload();
                }
            });
    }
}
</script>
